#!/usr/bin/env bash
set -e

# ==========================================
# Configuration
# ==========================================
PLUGIN_ID="org.kde.plasma.kuallpapers"
SCRIPT_DIR="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"
PROJECT_ROOT="$(realpath "$SCRIPT_DIR/..")"
METADATA_FILE="$PROJECT_ROOT/metadata.json"
USER_INSTALL_DIR="$HOME/.local/share/plasma/wallpapers/$PLUGIN_ID"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ==========================================
# Helper Functions
# ==========================================

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

check_requirements() {
    if [ ! -f "$METADATA_FILE" ]; then
        log_error "metadata.json not found at $METADATA_FILE"
        exit 1
    fi
}

get_version() {
    grep '"Version"' "$METADATA_FILE" | sed 's/.*"Version": "\([^"]*\)".*/\1/'
}

# ==========================================
# Commands
# ==========================================

cmd_install() {
    log_info "Installing to $USER_INSTALL_DIR..."

    rm -rf "$USER_INSTALL_DIR"
    mkdir -p "$USER_INSTALL_DIR"

    # Copy files
    cp -r "$PROJECT_ROOT/contents" "$USER_INSTALL_DIR/"
    cp "$PROJECT_ROOT/metadata.json" "$USER_INSTALL_DIR/"
    if [ -d "$PROJECT_ROOT/images" ]; then
        cp -r "$PROJECT_ROOT/images" "$USER_INSTALL_DIR/"
    fi

    log_success "Installation complete."
    log_info "You may need to restart Plasma or re-select the wallpaper."
}

cmd_uninstall() {
    log_info "Removing $USER_INSTALL_DIR..."
    rm -rf "$USER_INSTALL_DIR"
    log_success "Uninstalled."
}

cmd_test() {
    cmd_install
    log_info "Opening wallpaper settings..."

    if command -v kcmshell6 &> /dev/null; then
        kcmshell6 kcm_wallpaper || kcmshell6 plasma/wallpapers &
    elif command -v kcmshell5 &> /dev/null; then
        kcmshell5 kcm_wallpaper &
    else
        systemsettings kcm_wallpaper &
    fi
}

cmd_package() {
    local version=$(get_version)
    local package_name="kuallpapers-${version}"
    local package_file="${package_name}.tar.xz"
    local temp_dir="/tmp/${package_name}"

    log_info "Packaging version $version..."

    rm -rf "$temp_dir"
    mkdir -p "$temp_dir"

    # Copy release files
    cp -r "$PROJECT_ROOT/contents" "$temp_dir/"
    cp "$PROJECT_ROOT/metadata.json" "$temp_dir/"
    if [ -d "$PROJECT_ROOT/images" ]; then
        cp -r "$PROJECT_ROOT/images" "$temp_dir/"
    fi
    cp "$PROJECT_ROOT/README.md" "$temp_dir/"

    # Optional screenshots
    if compgen -G "$PROJECT_ROOT/Screenshot_*.png" > /dev/null; then
        cp "$PROJECT_ROOT"/Screenshot_*.png "$temp_dir/"
    fi

    # Create archive
    local working_dir=$(pwd)
    cd "$temp_dir"
    tar -cJf "${package_file}" *
    mv "${package_file}" "$PROJECT_ROOT/"
    cd "$working_dir"

    rm -rf "$temp_dir"
    log_success "Package created: $PROJECT_ROOT/$package_file"
}

cmd_plasmoid() {
    local version=$(get_version)
    local package_file="kuallpapers-${version}.plasmoid"

    log_info "Creating KDE Store-compatible plasmoid package for version $version..."

    # Create clean archive with only necessary files for KDE Store
    tar -czf "$PROJECT_ROOT/$package_file" \
        --exclude='.git*' \
        --exclude='.bin' \
        --exclude='.envrc' \
        --exclude='*.tar.xz' \
        --exclude='*.plasmoid' \
        --exclude='Screenshot_*.png' \
        -C "$PROJECT_ROOT" \
        metadata.json \
        contents \
        LICENSE \
        README.md \
        $([ -d "$PROJECT_ROOT/images" ] && echo "images" || echo "")

    log_success "KDE Store package created: $PROJECT_ROOT/$package_file"
    log_info "Upload this file to https://store.kde.org"
}

cmd_release() {
    local draft="false"
    local prerelease="false"

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --draft)
                draft="true"
                shift
                ;;
            --prerelease)
                prerelease="true"
                shift
                ;;
            *)
                log_error "Unknown option: $1"
                echo "Usage: release [--draft] [--prerelease]"
                exit 1
                ;;
        esac
    done

    # Check dependencies
    if ! command -v gh &> /dev/null; then
        log_error "GitHub CLI (gh) is not installed."
        exit 1
    fi

    # Check git status
    if [ -n "$(git -C "$PROJECT_ROOT" status --porcelain)" ]; then
        log_warn "You have uncommitted changes."
        git -C "$PROJECT_ROOT" status --short
        read -p "Continue anyway? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_error "Aborted."
            exit 1
        fi
    fi

    local version=$(get_version)

    # Check if tag exists BEFORE packaging
    local tag="v$version"
    if git -C "$PROJECT_ROOT" tag -l | grep -q "^$tag$"; then
        log_warn "Tag $tag already exists."
        read -p "Delete existing tag and continue? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            git -C "$PROJECT_ROOT" tag -d "$tag"
            git -C "$PROJECT_ROOT" push origin ":refs/tags/$tag" 2>/dev/null || true
        else
            log_error "Aborted."
            exit 1
        fi
    fi

    # Create packages
    cmd_package
    cmd_plasmoid
    local package_file="kuallpapers-${version}.tar.xz"
    local plasmoid_file="kuallpapers-${version}.plasmoid"

    # Create GitHub release
    local title="Kuallpapers v$version"

    log_info "Creating release $tag..."

    # Prepare release notes - Customized for Manual Schedule
    local release_notes="## Kuallpapers v$version

### Features
- Manual schedule configuration for accurate timing
- Improved performance and reliability
- Support for dawn, morning, day, evening, dusk, and night phases

### Installation

#### From KDE Store (Recommended)
1. Open KDE System Settings → Appearance → Wallpaper
2. Click \"Get New Wallpapers\"
3. Search for \"Kuallpapers\" and install

#### Manual Installation
1. Download \`$plasmoid_file\` below
2. Run: \`kpackagetool6 --type Plasma/Wallpaper --install $plasmoid_file\`
3. Right-click desktop → Configure Desktop and Wallpaper → Select \"Kuallpapers\"

#### For Developers
Download \`$package_file\` for the full source package with development tools."

    # Execute release
    gh release create "$tag" \
        "$PROJECT_ROOT/$package_file" \
        "$PROJECT_ROOT/$plasmoid_file" \
        --title "$title" \
        --notes "$release_notes" \
        --draft="$draft" \
        --prerelease="$prerelease"

    if [ "$draft" = "true" ]; then
        log_success "Draft release created: https://github.com/zp1ke/kuallpapers/releases/tag/$tag"
    elif [ "$prerelease" = "true" ]; then
        log_success "Pre-release created: https://github.com/zp1ke/kuallpapers/releases/tag/$tag"
    else
        log_success "Release created: https://github.com/zp1ke/kuallpapers/releases/tag/$tag"
    fi
}

cmd_clean() {
    log_info "Cleaning artifacts..."
    rm -f "$PROJECT_ROOT"/*.tar.xz
    rm -f "$PROJECT_ROOT"/*.plasmoid
    log_success "Cleaned."
}

show_usage() {
    echo "Kuallpapers CLI Tool"
    echo "Usage: $(basename "$0") [command]"
    echo ""
    echo "Commands:"
    echo "  install     Install plugin to user directory"
    echo "  uninstall   Remove plugin from user directory"
    echo "  test        Install and open system settings"
    echo "  package     Build .tar.xz package for release"
    echo "  plasmoid    Create KDE Store-compatible .plasmoid package"
    echo "  release     Create GitHub release (requires gh cli)"
    echo "              Options: --draft (create draft release)"
    echo "                       --prerelease (mark as pre-release)"
    echo "  clean       Remove temporary files"
    echo "  help        Show this help"
    echo "  completions Generate shell completions (bash|fish|zsh)"
}

cmd_completions() {
    local shell=${1:-bash}
    case "$shell" in
        fish)
            echo "# Fish completions for dev script"
            echo "complete -c dev -f -n \"__fish_use_subcommand\" -a install -d \"Install plugin to user directory\""
            echo "complete -c dev -f -n \"__fish_use_subcommand\" -a uninstall -d \"Remove plugin from user directory\""
            echo "complete -c dev -f -n \"__fish_use_subcommand\" -a test -d \"Install and open system settings\""
            echo "complete -c dev -f -n \"__fish_use_subcommand\" -a package -d \"Build .tar.xz package for release\""
            echo "complete -c dev -f -n \"__fish_use_subcommand\" -a release -d \"Create GitHub release\""
            echo "complete -c dev -f -n \"__fish_use_subcommand\" -a clean -d \"Remove temporary files\""
            echo "complete -c dev -f -n \"__fish_use_subcommand\" -a help -d \"Show help\""
            ;;
        bash)
            echo "# Bash completions for dev script"
            echo "_dev() {"
            echo "    local cur prev opts"
            echo "    COMPREPLY=()"
            echo "    cur=\"\${COMP_WORDS[COMP_CWORD]}\""
            echo "    prev=\"\${COMP_WORDS[COMP_CWORD-1]}\""
            echo "    opts=\"install uninstall test package release clean help completions\""
            echo "    if [[ \${cur} == * ]]; then"
            echo "        COMPREPLY=( \$(compgen -W \"\${opts}\" -- \${cur}) )"
            echo "        return 0"
            echo "    fi"
            echo "}"
            echo "complete -F _dev dev"
            ;;
        zsh)
            echo "# Zsh completions for dev script"
            echo "# Place within your fpath"
            echo "#compdef dev"
            echo "local -a args"
            echo "args=("
            echo "  'install:Install plugin to user directory'"
            echo "  'uninstall:Remove plugin from user directory'"
            echo "  'test:Install and open system settings'"
            echo "  'package:Build .tar.xz package for release'"
            echo "  'release:Create GitHub release'"
            echo "  'clean:Remove temporary files'"
            echo "  'help:Show help'"
            echo ")"
            echo "_describe -t commands 'dev commands' args"
            ;;
        *)
            log_error "Unknown shell: $shell. Supported: bash, fish, zsh"
            exit 1
            ;;
    esac
}

# ==========================================
# Main
# ==========================================

check_requirements

case "${1:-help}" in
    install)   cmd_install ;;
    uninstall) cmd_uninstall ;;
    test)      cmd_test ;;
    plasmoid)  cmd_plasmoid ;;
    package)   cmd_package ;;
    release)   shift; cmd_release "$@" ;;
    clean)     cmd_clean ;;
    help|-h|--help) show_usage ;;
    completions) cmd_completions "$2" ;;
    *)
        log_error "Unknown command '$1'"
        show_usage
        exit 1
        ;;
esac
